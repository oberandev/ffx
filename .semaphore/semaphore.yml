version: v1.0

name: ffx

agent:
  machine:
    type: e2-standard-2
    os_image: ubuntu2204

auto_cancel:
  queued:
    when: "true"

global_job_config:
  env_vars:
    - name: NODE_ENV
      value: test
  prologue:
    commands:
      - sem-version node 20
      - corepack enable
      - corepack prepare pnpm@latest-8 --activate
      - checkout
      - cache restore node-$(checksum pnpm-lock.yaml)

blocks:
  - name: "\U0001F4E6 Install dependencies"
    task:
      jobs:
        - name: pnpm install
          commands:
            - pnpm install
            - cache store node-$(checksum pnpm-lock.yaml) $(pnpm store path)

  - name: "\U0001F50D Static Analysis"
    task:
      prologue:
        commands:
          - pnpm install
      jobs:
        - name: prettier & eslint
          commands:
            - pnpm nx run-many -t format:check
            - pnpm nx run-many -t lint

        - name: pnpm audit
          commands:
            - pnpm audit --prod

  - name: "\U0001F9EA Unit Tests"
    task:
      prologue:
        commands:
          - pnpm install
      secrets:
        - name: codecov
        - name: geocodio
      jobs:
        - name: vitest
          commands:
            - curl -Os https://uploader.codecov.io/latest/linux/codecov
            - chmod +x codecov
            - pnpm nx run-many -t test
            - ./codecov
